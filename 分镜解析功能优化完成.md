# 分镜解析功能优化完成

**完成时间**: 2026-01-14 17:09  
**状态**: ✅ 已优化

---

## 问题描述

分镜设计页面无法正确解析剧本，导致：
1. 生成的场景数量与剧本不符
2. 场景内容与剧本无关
3. 无法识别特定格式的剧本（如 `**场景1 - 地点 - 时间**`）

## 根本原因

`parseScriptToScenes` 函数的场景识别逻辑过于简单，只能识别基础格式：
- `场景1`
- `INT./EXT.`
- `内景/外景`

无法识别更复杂的格式：
- `**场景1 - 魔法列车车厢内 - 傍晚**`
- 场景描述（【】标记）
- 角色对话（**角色名**：）

---

## 优化内容

### 增强场景标题识别

**支持的格式**：
```javascript
/^\*\*场景\s*\d+/i          // **场景1 - xxx**
/^场景\s*\d+/i              // 场景1 - xxx
/^(INT\.|EXT\.)/i           // INT./EXT.
/^(内景|外景)/i             // 内景/外景
/^第[一二三四五六七八九十\d]+场/i  // 第一场
/^---\s*$/i                 // --- 分隔符
```

### 智能解析地点和时间

从场景标题中提取信息：
```
**场景1 - 魔法列车车厢内 - 傍晚**
↓
场景号: 1
地点: 内景 - 魔法列车车厢内
时间: 昏
```

**时间识别**：
- 夜：夜、晚上、深夜、午夜
- 晨：晨、早上、清晨、黎明
- 昏：昏、黄昏、傍晚
- 日：日、白天、中午

**地点类型自动判断**：
- 内景：车厢、房间、大厅、走廊、图书馆等
- 外景：大门、峡谷、平台、钟楼等

### 识别场景描述

支持【】标记的场景描述：
```
【车厢内灯光柔和，窗外是飞驰而过的紫色山脉...】
```

### 识别角色对话

支持多种对话格式：
```
**林小雨**：（自言自语）真的……能进圣星学院吗？
艾登：这位置有人吗？
```

自动提取角色列表并记录对话内容。

### 识别动作描述

其他非对话内容作为动作描述：
```
【她打开木匣，里面是一枚裂开的银质星徽...】
```

---

## 测试用例

### 输入剧本
```
**场景1 - 魔法列车车厢内 - 傍晚**

【车厢内灯光柔和，窗外是飞驰而过的紫色山脉...】

**林小雨**：（自言自语）真的……能进圣星学院吗？

【她打开木匣，里面是一枚裂开的银质星徽...】

**艾登**：这位置有人吗？

---

**场景2 - 圣星学院大门前 - 夜**

【巍峨的石门悬浮于悬崖之上...】
```

### 解析结果
```json
[
  {
    "sceneNumber": 1,
    "title": "场景1 - 魔法列车车厢内 - 傍晚",
    "location": "内景 - 魔法列车车厢内",
    "timeOfDay": "昏",
    "description": "车厢内灯光柔和，窗外是飞驰而过的紫色山脉...\n她打开木匣，里面是一枚裂开的银质星徽...",
    "characters": ["林小雨", "艾登"],
    "dialogue": "**林小雨**：（自言自语）真的……能进圣星学院吗？\n**艾登**：这位置有人吗？",
    "action": "..."
  },
  {
    "sceneNumber": 2,
    "title": "场景2 - 圣星学院大门前 - 夜",
    "location": "外景 - 圣星学院大门前",
    "timeOfDay": "夜",
    "description": "巍峨的石门悬浮于悬崖之上...",
    "characters": [],
    "dialogue": "",
    "action": "..."
  }
]
```

---

## 使用方法

### 1. 在剧本编辑器中输入剧本

使用标准格式：
```
**场景X - 地点 - 时间**

【场景描述】

**角色名**：对话内容

【动作描述】

---

**场景Y - 地点 - 时间**
...
```

### 2. 进入分镜设计页面

点击"自动生成分镜"按钮

### 3. 系统处理流程

1. **优先使用 AI 解析**：调用通义千问 API 智能分析剧本
2. **降级方案**：如果 AI 失败，使用优化后的规则解析
3. **保存到数据库**：将解析的场景保存
4. **返回结果**：显示生成的场景列表

---

## 技术细节

### 函数签名
```javascript
function parseScriptToScenes(scriptContent: string): Scene[]
```

### 返回数据结构
```typescript
interface Scene {
  sceneNumber: number;      // 场景号
  title: string;            // 场景标题
  description: string;      // 场景描述
  location: string;         // 地点
  timeOfDay: string;        // 时间（日/夜/晨/昏）
  characters: string[];     // 出场角色
  dialogue: string;         // 对话内容
  action: string;           // 动作描述
}
```

### 日志输出
```
✓ 解析剧本识别到 6 个场景
```

---

## API 端点

### 生成分镜
```
POST /api/projects/:projectId/generate-storyboard
```

**请求**：无需 body（从项目剧本读取）

**响应**：
```json
{
  "success": true,
  "message": "成功生成 6 个场景",
  "scenes": [...]
}
```

---

## 注意事项

### 剧本格式建议

1. **使用明确的场景标记**
   ```
   **场景1 - 地点 - 时间**
   ```

2. **使用【】标记场景描述**
   ```
   【详细的视觉描述...】
   ```

3. **使用 ** 标记角色名**
   ```
   **角色名**：对话内容
   ```

4. **使用 --- 分隔场景**
   ```
   ---
   ```

### AI 解析优先

系统会优先使用通义千问 AI 进行智能解析，只有在 AI 失败时才使用规则解析。

### 环境变量要求

确保 `.env.production` 中配置了：
```bash
QWEN_API_KEY=sk-414b2deb58c9484f91e468679a195005
```

---

## 完成状态

- ✅ 场景标题识别增强（支持 6 种格式）
- ✅ 地点和时间智能解析
- ✅ 场景描述识别（【】标记）
- ✅ 角色对话识别（** 标记）
- ✅ 动作描述提取
- ✅ 角色列表自动提取
- ✅ 日志输出优化
- ✅ 后端服务已重启
- ✅ 环境变量已加载

**分镜解析功能已完全优化！现在可以正确识别你提供的剧本格式。**
