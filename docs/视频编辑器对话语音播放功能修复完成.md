# 视频编辑器对话语音播放功能修复完成

## 修复时间
2026-01-14

## 问题描述
生成了50段对话语音后,播放时听不到任何声音。控制台显示关键错误:**时间范围是 NaN** (`时间范围: NaN - NaN`)

## 根本原因
**阿里云TTS服务返回的数据结构中缺少 `duration` 字段**

1. 后端 `aliyunTTS.synthesize()` 方法返回的对象只包含:
   - `success`
   - `audioUrl`
   - `format`
   - `size`
   - `textLength`
   - **没有 `duration` 字段!**

2. 前端代码尝试读取 `response.data.duration`,得到 `undefined`
3. `undefined || 3` 虽然应该返回 3,但在某些情况下仍然导致 NaN
4. `dialogue.startTime` 和 `dialogue.duration` 变成 NaN
5. 播放条件判断 `currentTime >= NaN` 永远为 false,导致音频永远不播放

## 解决方案

### 1. 后端修复 (Projects/AIMovie/server/services/aliyunTTS.cjs)

在 `synthesize()` 方法中添加音频时长估算:

```javascript
// 估算音频时长（基于文本长度和语速）
// 中文平均每个字约0.3-0.4秒，考虑语速调整
const baseCharsPerSecond = 3.5; // 正常语速约3.5字/秒
const speedFactor = 1 + (speechRate / 1000); // speechRate范围-500到500
const estimatedDuration = Math.max(1, text.length / (baseCharsPerSecond * speedFactor));

return {
  success: true,
  audioUrl: audioDataUrl,
  format: format,
  size: response.data.length,
  textLength: text.length,
  duration: parseFloat(estimatedDuration.toFixed(2)), // 保留2位小数
  text: text,
  voice: voice
};
```

**估算逻辑:**
- 中文正常语速约 3.5 字/秒
- 根据 `speechRate` 参数调整速度因子
- 最小时长为 1 秒
- 保留 2 位小数

### 2. 前端加固 (Projects/AIMovie/src/pages/VideoEditor/index.tsx)

使用 `Number()` 确保 duration 是数字:

```typescript
const duration = Number(response.data.duration) || 3 // 确保duration是数字,默认3秒
```

**改进点:**
- `Number(undefined)` 返回 `NaN`
- `NaN || 3` 返回 `3`
- 确保 duration 永远是有效数字

### 3. 调试日志增强

添加更详细的调试信息:

```typescript
console.log('创建对话:', dialogue.character, 'startTime:', dialogueStartTime, 'duration:', duration, 'response.data.duration:', response.data.duration)
```

## 修改文件

1. `Projects/AIMovie/server/services/aliyunTTS.cjs`
   - 添加 duration 估算逻辑
   - 在正常返回和重试返回中都添加 duration 字段

2. `Projects/AIMovie/src/pages/VideoEditor/index.tsx`
   - 使用 `Number()` 确保 duration 是数字
   - 添加调试日志

## 部署步骤

1. 重启后端服务:
   ```bash
   pm2 restart aimovie-api
   ```

2. 重新构建前端:
   ```bash
   cd Projects/AIMovie
   npm run build
   ```

3. 刷新浏览器测试

## 测试验证

1. 打开视频编辑器页面
2. 点击"生成对话语音"按钮
3. 等待语音生成完成
4. 查看控制台日志,确认:
   - `response.data.duration` 有值(不是 undefined)
   - `startTime` 和 `duration` 都是有效数字(不是 NaN)
   - 时间范围显示正常(例如: `时间范围: 0 - 2.5`)
5. 点击播放按钮
6. 确认能听到对话语音

## 预期结果

- 控制台显示: `创建对话: 艾登 startTime: 0 duration: 2.5 response.data.duration: 2.5`
- 控制台显示: `检查对话: 艾登 时间范围: 0 - 2.5 音频对象: 存在`
- 播放时能听到对话语音
- 时间线上的对话片段长度与实际音频时长匹配

## 注意事项

1. **时长估算的准确性**
   - 当前使用文本长度估算,可能与实际音频时长有偏差
   - 如果需要精确时长,可以考虑:
     - 使用音频解析库(如 `audio-duration`)
     - 在浏览器中加载音频后读取 `audio.duration`
     - 调用阿里云API获取精确时长(如果API支持)

2. **调试日志**
   - 当前 `drop_console: false` 用于调试
   - 修复验证后,建议改回 `drop_console: isProduction`

3. **性能优化**
   - 估算逻辑非常轻量,不会影响性能
   - 如果未来需要精确时长,可能需要异步处理

## 相关文档

- [AI对话语音生成功能实现完成.md](./AI对话语音生成功能实现完成.md)
- [视频编辑器播放功能实现说明.md](./视频编辑器播放功能实现说明.md)
- [视频编辑器时间线功能实现完成.md](./视频编辑器时间线功能实现完成.md)
