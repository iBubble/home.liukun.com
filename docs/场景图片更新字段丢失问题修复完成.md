# 场景图片更新字段丢失问题修复完成

## 修复时间
2026-01-15

## 问题描述
在 AIMovie 项目的分镜设计页面（Storyboard Designer）中，当生成场景图片后，场景的标题（title）、地点（location）和时间（timeOfDay）等字段被错误删除，只保留了图片URL。

## 问题原因
在 `Projects/AIMovie/src/pages/StoryboardDesigner/index.tsx` 文件中，有两个函数在更新场景图片时存在问题：

1. **generateImagesForScenes** 函数（第113-140行）
   - 用于批量为所有场景生成图像
   - 调用 `updateScene` 时只传递了 `aiGeneratedImage` 字段

2. **handleRegenerateSceneImage** 函数（第142-170行）
   - 用于为单个场景重新生成图像
   - 同样只传递了 `aiGeneratedImage` 字段

后端 API (`PUT /api/projects/:projectId/scenes/:sceneId`) 使用 `?? null` 处理未定义字段，导致未传递的字段被设置为 null，从而丢失了原有数据。

## 修复方案
修改两个函数，在调用 `updateScene` 时传递完整的场景数据：

### 修复前的代码
```typescript
const updatedScene = await updateScene(id!, scene.id, {
  aiGeneratedImage: result.imageUrl
})
```

### 修复后的代码
```typescript
const updatedScene = await updateScene(id!, scene.id, {
  title: scene.title,
  description: scene.description,
  location: scene.location,
  timeOfDay: scene.timeOfDay,
  duration: scene.duration,
  characters: scene.characters,
  dialogue: scene.dialogue,
  action: scene.action,
  cameraNotes: scene.cameraNotes,
  aiGeneratedImage: result.imageUrl
})
```

## 修改的文件
- `Projects/AIMovie/src/pages/StoryboardDesigner/index.tsx`
  - 修复 `generateImagesForScenes` 函数（约第113行）
  - 修复 `handleRegenerateSceneImage` 函数（约第142行）

## 验证步骤
1. 访问 http://home.liukun.com/Projects/AIMovie/
2. 进入任意项目的分镜设计页面
3. 点击"从剧本生成分镜"按钮
4. 等待场景图片自动生成
5. 验证场景的标题、地点、时间等字段是否保留
6. 点击单个场景的"重新生成"按钮
7. 验证字段是否依然保留

## 技术细节
- 前端框架：React + TypeScript
- 状态管理：Redux Toolkit
- 构建工具：Webpack 5
- 后端 API：Node.js + Express

## 相关参考
- 对比函数：`handleApplyImage` 函数（约第172行）正确实现了完整字段传递
- 后端 API 实现：`Projects/AIMovie/server/index.cjs` 中的场景更新接口
- API 服务：`Projects/AIMovie/src/services/sceneApi.ts`

## 构建状态
✅ 前端代码已重新构建
✅ 生产环境文件已更新
✅ 所有功能正常运行

## 后续建议
1. 考虑在后端 API 中改进字段更新逻辑，使用 `undefined` 检查而非 `?? null`
2. 添加单元测试覆盖场景更新逻辑
3. 在前端添加字段验证，防止关键字段丢失
