# 视频编辑器播放功能实现说明

## 实现时间
2026-01-15

## 已实现功能

### 1. 基础播放控制 ✅
- **播放/暂停按钮**：点击播放按钮开始播放，再次点击暂停
- **自动播放**：按照时间轴自动切换场景图片
- **时间更新**：每 100ms 更新一次当前时间
- **播放结束**：播放到末尾自动停止并重置到开始

### 2. 场景图片切换 ✅
- **自动切换**：根据当前时间自动显示对应场景的图片
- **无缝衔接**：场景之间平滑切换
- **高亮显示**：当前播放的场景在时间线上自动高亮

### 3. 背景音乐 ✅
- **自动播放**：点击播放按钮时同步播放背景音乐
- **循环播放**：背景音乐循环播放
- **同步控制**：播放/暂停时音乐同步控制
- **时间同步**：音乐播放位置与时间轴同步

## 技术实现

### 播放控制逻辑
```typescript
// 播放定时器
useEffect(() => {
  if (isPlaying) {
    playIntervalRef.current = setInterval(() => {
      setCurrentTime(prev => {
        const newTime = prev + 0.1
        if (newTime >= totalDuration) {
          setIsPlaying(false)
          return 0
        }
        return newTime
      })
    }, 100)
  } else {
    if (playIntervalRef.current) {
      clearInterval(playIntervalRef.current)
    }
  }
}, [isPlaying, totalDuration])
```

### 场景切换逻辑
```typescript
// 根据当前时间查找对应场景
useEffect(() => {
  const currentClip = clips.find(clip => 
    clip.track === 0 &&
    currentTime >= clip.startTime && 
    currentTime < clip.startTime + clip.duration
  )
  
  if (currentClip && currentClip.type !== 'audio') {
    setPreviewUrl(currentClip.url)
    setSelectedClip(currentClip)
  }
}, [currentTime, clips])
```

### 音频控制
```typescript
const handlePlayPause = () => {
  if (isPlaying) {
    setIsPlaying(false)
    if (audioRef.current) {
      audioRef.current.pause()
    }
  } else {
    setIsPlaying(true)
    if (audioRef.current) {
      audioRef.current.currentTime = currentTime
      audioRef.current.play()
    }
  }
}
```

## 待实现功能

### 2. AI 对话语音生成 🔄
**需求**：将场景中的对话转换为对应性别和性格的人物语音

**实现方案**：
1. 从场景数据中提取对话内容
2. 根据角色性别和性格选择合适的 TTS 音色
3. 调用 `/api/tts/synthesize` API 生成语音
4. 将生成的语音添加到时间线音频轨道
5. 在对应时间播放对话语音

**API 接口**（已存在）：
```javascript
POST /api/tts/synthesize
{
  "text": "对话内容",
  "voice": "xiaoyun", // 音色ID
  "speechRate": 0,    // 语速
  "pitchRate": 0,     // 音调
  "volume": 50        // 音量
}
```

**可用音色**：
- 女声：xiaoyun（温柔）、xiaogang（活泼）、ruoxi（知性）
- 男声：zhichu（沉稳）、sicheng（磁性）、aijia（年轻）

### 3. AI 音效生成 🔄
**需求**：根据场景需要生成音效（如脚步声、开门声、风声等）

**实现方案**：
1. 分析场景描述，识别需要音效的地方
2. 使用 AI 生成音效描述
3. 调用音效生成 API（需要集成第三方服务）
4. 将音效添加到时间线
5. 在对应时间播放音效

**可选服务**：
- ElevenLabs Sound Effects
- Stability AI Audio
- 本地音效库（预设常用音效）

## 数据结构

### 场景数据（Scene）
```typescript
interface Scene {
  id: string
  sceneNumber: number
  title: string
  description: string
  location: string
  timeOfDay: string
  duration?: number
  characters: string[]
  dialogue?: string      // 对话内容
  action?: string        // 动作描述
  cameraNotes?: string
  aiGeneratedImage?: string
}
```

### 时间线片段（TimelineClip）
```typescript
interface TimelineClip {
  id: string
  type: 'video' | 'audio' | 'image' | 'text'
  name: string
  thumbnail: string
  url: string
  startTime: number
  duration: number
  track: number
}
```

## 后续优化建议

### 短期优化
1. **对话语音生成**
   - 为每个场景的对话生成语音
   - 根据角色匹配合适的音色
   - 自动计算对话时长

2. **音效库集成**
   - 预设常用音效（脚步、开门、风声等）
   - 支持手动添加音效到时间线
   - 音效音量和淡入淡出控制

3. **播放优化**
   - 添加播放速度控制（0.5x, 1x, 1.5x, 2x）
   - 添加音量控制滑块
   - 支持键盘快捷键（空格播放/暂停）

### 中期优化
1. **高级音频编辑**
   - 音频波形显示
   - 精确的音频剪辑
   - 音频淡入淡出效果
   - 多音轨混音

2. **转场效果**
   - 淡入淡出
   - 擦除
   - 推移
   - 溶解

3. **字幕功能**
   - 自动生成字幕
   - 字幕样式编辑
   - 字幕时间轴调整

### 长期优化
1. **视频导出**
   - 导出为 MP4 格式
   - 自定义分辨率和帧率
   - 添加水印
   - 批量导出

2. **AI 智能剪辑**
   - 自动识别精彩片段
   - 智能配乐
   - 自动调色
   - 智能字幕

## 测试步骤

### 基础播放测试
1. 访问 http://home.liukun.com/Projects/AIMovie/
2. 进入任意项目的视频编辑器
3. 点击播放按钮 ▶
4. 验证场景图片是否按时间轴自动切换
5. 验证背景音乐是否同步播放
6. 点击暂停按钮 ⏸
7. 验证播放是否暂停
8. 拖动进度条，验证场景是否跳转

### 时间线测试
1. 验证当前播放的场景是否高亮显示
2. 验证时间指针是否正确移动
3. 验证播放到末尾是否自动停止

## 相关文件

### 前端文件
- `Projects/AIMovie/src/pages/VideoEditor/index.tsx` - 视频编辑器主页面
- `Projects/AIMovie/src/services/sceneApi.ts` - 场景 API 服务

### 后端文件
- `Projects/AIMovie/server/routes/tts.cjs` - TTS 语音合成路由
- `Projects/AIMovie/server/services/aliyunTTS.cjs` - 阿里云 TTS 服务

## 技术栈
- React 18 + TypeScript
- Web Audio API
- HTML5 Audio Element
- 阿里云 TTS（语音合成）
- 通义千问（AI 分析）

## 注意事项

1. **浏览器兼容性**
   - 音频自动播放可能被浏览器阻止
   - 需要用户交互后才能播放音频
   - 建议添加提示引导用户点击

2. **性能优化**
   - 大量音频文件可能占用内存
   - 建议使用音频预加载和缓存
   - 及时释放不用的音频资源

3. **网络优化**
   - TTS 生成需要网络请求
   - 建议预先生成并缓存语音文件
   - 添加加载状态提示

## 总结

✅ 基础播放功能已实现
✅ 场景图片自动切换已实现
✅ 背景音乐同步播放已实现
🔄 AI 对话语音生成待实现
🔄 AI 音效生成待实现

当前版本已经可以实现基本的视频预览功能，用户可以看到场景按时间轴播放的效果。后续将逐步添加 AI 语音和音效功能，使视频更加生动。
