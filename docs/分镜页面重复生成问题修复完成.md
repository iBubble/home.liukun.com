# 分镜页面重复生成问题修复完成

## 修复时间
2026-01-15

## 问题描述
分镜页面存在严重的重复生成场景问题:
1. 页面不停生成场景图片,数量远超场景数
2. 刷新后依然在不停生成
3. 从视频编辑页面返回分镜时,发现12个场景每个出现2个
4. 到某个时候全部清除又重新生成

## 问题根源分析

### 1. 前端防护不足
- `isGeneratingStoryboardRef` 已声明但未使用
- `handleGenerateStoryboard` 函数没有防止重复调用的保护
- 多个触发点可能同时调用生成函数

### 2. 状态检查不完整
- 自动生成的 useEffect 只检查了 `isGeneratingStoryboard` 状态
- 没有检查 `isGeneratingStoryboardRef.current` 引用值
- localStorage 标记存在但检查不够严格

## 修复方案

### 1. 添加 Ref 锁机制
在 `handleGenerateStoryboard` 函数开头添加:
```typescript
// 防止重复调用
if (isGeneratingStoryboardRef.current) {
  console.log('⚠️ 分镜生成已在进行中,跳过重复调用')
  return
}

try {
  isGeneratingStoryboardRef.current = true
  setIsGeneratingStoryboard(true)
  // ... 生成逻辑
} finally {
  setIsGeneratingStoryboard(false)
  isGeneratingStoryboardRef.current = false
}
```

### 2. 增强自动生成检查
在自动生成的 useEffect 中添加更严格的检查:
```typescript
if (id && !loadingScenes && scenes.length === 0 && 
    project?.script?.content && 
    !isGeneratingStoryboard && 
    !isGeneratingStoryboardRef.current) {
  // ... 自动生成逻辑
}
```

### 3. 改进日志输出
添加更详细的日志,便于调试:
- `✓ 自动生成分镜(首次)` - 首次自动生成
- `⚠️ 已标记为自动生成过,跳过` - 跳过重复生成
- `⚠️ 分镜生成已在进行中,跳过重复调用` - 防止并发调用

## 修复的文件
- `Projects/AIMovie/src/pages/StoryboardDesigner/index.tsx`

## 修复内容

### 1. handleGenerateStoryboard 函数
- 在函数开头添加 `isGeneratingStoryboardRef.current` 检查
- 在 try 块开始时设置 `isGeneratingStoryboardRef.current = true`
- 在 finally 块中重置 `isGeneratingStoryboardRef.current = false`

### 2. 自动生成 useEffect
- 添加 `!isGeneratingStoryboardRef.current` 到依赖检查
- 添加更详细的日志输出
- 改进 localStorage 检查逻辑

## 技术细节

### 为什么使用 useRef 而不是 useState?
1. **同步性**: `useRef` 的值立即更新,不需要等待 React 重新渲染
2. **防止竞态**: 在快速连续调用时,`useState` 可能还没更新,导致多次调用都通过检查
3. **不触发渲染**: 修改 `useRef` 不会触发组件重新渲染,避免不必要的性能开销

### 双重保护机制
1. **localStorage**: 防止页面刷新后重复自动生成
2. **useRef**: 防止同一会话中的并发调用
3. **useState**: 提供 UI 状态反馈(按钮禁用、加载提示等)

## 测试建议

### 1. 基础功能测试
- [ ] 首次进入分镜页面,自动生成场景(只生成一次)
- [ ] 刷新页面,不再自动生成
- [ ] 手动点击"重新生成分镜",正常工作
- [ ] 快速多次点击"重新生成分镜",只执行一次

### 2. 场景切换测试
- [ ] 从分镜页面进入视频编辑页面
- [ ] 从视频编辑页面返回分镜页面
- [ ] 确认场景数量正确,没有重复

### 3. 并发测试
- [ ] 在生成过程中刷新页面
- [ ] 在生成过程中切换到其他页面再返回
- [ ] 确认没有产生重复场景

### 4. 日志检查
打开浏览器控制台,检查日志输出:
- 应该看到 `✓ 自动生成分镜(首次)` 只出现一次
- 后续刷新应该看到 `⚠️ 已标记为自动生成过,跳过`
- 并发调用应该看到 `⚠️ 分镜生成已在进行中,跳过重复调用`

## 后续优化建议

### 1. 后端幂等性
考虑在后端添加幂等性检查:
- 使用更可靠的ID生成方式(UUID而不是Date.now())
- 添加项目级别的生成锁
- 检查是否已存在场景,避免重复创建

### 2. 前端状态管理
- 考虑使用 Redux 或其他状态管理库统一管理生成状态
- 添加全局的生成队列,避免多个页面同时触发生成

### 3. 用户体验优化
- 添加生成进度条,显示当前进度
- 提供取消生成的功能
- 生成失败时提供重试选项

## 部署说明
1. 前端代码已编译完成
2. 无需重启后端服务
3. 清除浏览器缓存后测试
4. 建议清除相关项目的 localStorage: `localStorage.removeItem('autoGenerated_项目ID')`

## 验证步骤
1. 访问 https://home.liukun.com:8443/Projects/AIMovie/
2. 登录并进入一个有剧本的项目
3. 进入分镜设计页面
4. 观察控制台日志和场景生成情况
5. 刷新页面,确认不再重复生成
6. 从视频编辑页面返回,确认场景数量正确

## 相关文档
- [视频编辑器时间线功能实现完成.md](./视频编辑器时间线功能实现完成.md)
- [场景图片更新字段丢失问题修复完成.md](./场景图片更新字段丢失问题修复完成.md)
- [分镜解析功能优化完成.md](./分镜解析功能优化完成.md)
