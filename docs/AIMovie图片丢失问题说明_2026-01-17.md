# AIMovie 图片丢失问题说明

**日期**: 2026-01-17  
**问题**: 场景图片无法显示

## 问题原因

### 1. 图片存储方式问题
- AI 生成的场景图片存储在阿里云 OSS（通义万相结果桶）
- 数据库中保存的是**带签名的临时 URL**
- 签名有效期约 24 小时，过期后无法访问

### 2. 权限问题
- Bucket: `dashscope-result-bj`
- 错误: `AccessDenied - You have no right to access this object because of bucket acl`
- 当前 Access Key 无权访问该 bucket

### 3. 影响范围
- 受影响场景数: **35 个**
- 所有 AI 生成的场景图片均无法显示
- 素材库图片（Unsplash/Pexels）不受影响

## 数据统计

```sql
-- 受影响的场景
SELECT COUNT(*) FROM scenes 
WHERE ai_generated_image IS NOT NULL 
AND ai_generated_image LIKE '%dashscope-result%';
-- 结果: 35

-- 总场景数
SELECT COUNT(*) FROM scenes;
-- 结果: 85

-- 受影响比例: 41%
```

## 解决方案

### 方案 1: 重新生成图片（推荐）
**优点**: 获得新的有效图片  
**缺点**: 需要消耗 API 额度

实施步骤：
1. 为每个缺失图片的场景调用通义万相 API 重新生成
2. 将新图片下载到本地服务器
3. 更新数据库中的图片路径

### 方案 2: 使用占位图
**优点**: 快速解决显示问题  
**缺点**: 用户体验不佳

实施步骤：
1. 前端检测图片加载失败
2. 显示默认占位图
3. 提示用户"图片已过期，点击重新生成"

### 方案 3: 改进架构（长期方案）
**目标**: 避免将来再次出现此问题

改进措施：
1. **立即下载**: AI 生成图片后立即下载到本地
2. **本地存储**: 所有图片保存在 `/Projects/AIMovie/uploads/`
3. **数据库路径**: 只保存相对路径，不保存临时 URL
4. **备份策略**: 定期备份 uploads 目录

## 建议的新架构

```javascript
// 生成图片后的处理流程
async function handleGeneratedImage(scene_id, oss_url) {
  // 1. 立即下载到本地
  const local_path = await downloadToLocal(oss_url, scene_id);
  
  // 2. 保存本地路径到数据库
  await updateScene(scene_id, {
    ai_generated_image: `/Projects/AIMovie/uploads/scenes/${scene_id}.png`
  });
  
  // 3. 返回本地路径
  return local_path;
}
```

## 临时解决方案

当前可以：
1. 在前端添加图片加载失败处理
2. 显示占位图或"重新生成"按钮
3. 用户点击后调用 API 重新生成图片

## 需要的操作

1. **前端修改**: 添加图片错误处理
2. **后端修改**: 图片生成后立即下载到本地
3. **数据清理**: 清除所有过期的 OSS URL

## 相关文件

- 下载脚本: `Projects/AIMovie/scripts/download_oss_images.py`
- 上传目录: `Projects/AIMovie/uploads/scenes/`
- 数据库表: `scenes.ai_generated_image`
