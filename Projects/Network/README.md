# 网络监测系统

实时监测内网、国内网络和国外网络的连通性。

## 功能特性

### 监测目标
- **内网 (LAN)**: 192.168.1.1 - 路由器网关
- **国内网络 (WAN)**: www.baidu.com - 百度
- **国外网络 (INTL)**: 8.8.8.8 - Google DNS

### 核心功能
1. **实时监测**
   - 可配置监测间隔（每秒/每5秒/每10秒/每分钟）
   - 同时监测三个目标
   - 显示实时延迟和状态

2. **状态显示**
   - 在线/离线状态指示灯
   - 实时延迟显示
   - 成功率统计
   - 最后检测时间

3. **故障记录**
   - 自动记录故障开始时间
   - 记录故障持续时间
   - 故障恢复通知

4. **日志系统**
   - 实时日志记录
   - 按类型筛选（全部/错误/警告/信息）
   - 按网络筛选（全部/内网/国内/国外）
   - 日志导出功能（JSON格式）
   - **按会话自动保存到服务器**（Projects/Network/logs/）
   - **下拉菜单选择历史会话**
   - 永久保存，不会丢失

5. **统计信息**
   - 总检测次数
   - 总故障次数
   - 运行时间
   - **分别显示三个网络的平均延迟**

## 使用方法

### 访问地址
```
https://home.liukun.com:8443/Projects/Network/
```

### 操作步骤
1. 选择监测间隔
2. 点击"开始监测"按钮
3. 查看实时状态和日志
4. 需要时可以导出日志

### 按钮说明
- **开始监测**: 启动网络监测
- **停止监测**: 停止网络监测
- **清除日志**: 清空所有日志记录
- **导出日志**: 下载日志为JSON文件

## 技术实现

### 前端
- 纯HTML + CSS + JavaScript
- 赛博朋克风格UI
- 实时状态更新
- 会话选择和历史查看

### 后端
- PHP 8.2实现连接测试
- 使用fsockopen进行TCP连接测试
- 测试端口：192.168.1.1:80, www.baidu.com:80, 8.8.8.8:53
- 5秒超时保护
- 安全的目标地址白名单
- **日志会话管理API**（保存/加载/列表）

**注意**: 由于宝塔面板安全限制，PHP的exec()等系统命令函数被禁用，因此使用TCP连接测试代替ICMP ping。虽然不是真正的ping，但可以有效检测网络连通性和延迟。

### API接口

#### 1. 连接测试API
```
GET /api/ping.php?target=<目标地址>
```

**参数:**
- `target`: 目标地址 (192.168.1.1 | www.baidu.com | 8.8.8.8)

**响应格式:**
```json
{
  "success": true,
  "target": "www.baidu.com",
  "latency": 34.61,
  "timestamp": 1769078430,
  "method": "tcp",
  "port": 80
}
```

#### 2. 日志管理API
```
POST /api/network-logs.php?action=save
GET  /api/network-logs.php?action=list
GET  /api/network-logs.php?action=load&sessionId=<会话ID>
```

**保存会话:**
```json
{
  "sessionId": "session_1234567890",
  "startTime": "2026-01-22T10:00:00Z",
  "endTime": "2026-01-22T10:30:00Z",
  "logs": [...],
  "stats": {...}
}
```

## 监测逻辑

1. **正常状态**
   - 绿色指示灯
   - 显示延迟时间
   - 更新成功率

2. **故障检测**
   - 红色指示灯
   - 记录故障开始时间
   - 添加错误日志

3. **故障恢复**
   - 恢复绿色指示灯
   - 记录故障持续时间
   - 添加恢复日志

## 日志格式

```
[时间] 类型 [网络] 消息内容
```

**示例:**
```
[2026-01-21 01:30:45] ERROR [内网] 网络故障: 连接超时
[2026-01-21 01:31:00] INFO [内网] 网络已恢复 (故障持续: 00:00:15)
```

## 注意事项

1. **权限要求**
   - logs目录需要www用户写权限（777）
   - 日志文件自动创建为664权限

2. **性能考虑**
   - 建议使用5秒或更长的监测间隔
   - 避免过于频繁的连接测试

3. **日志管理**
   - 日志永久保存在服务器 Projects/Network/logs/
   - 每次监测会话自动保存
   - 可通过下拉菜单查看历史会话
   - 支持导出为JSON格式

4. **网络目标**
   - 内网目标需要确保路由器地址正确
   - 国外目标可能受防火墙影响
   - 可以修改API白名单添加其他目标

## 扩展建议

1. **添加更多监测目标**
   - 编辑 `api/ping.php` 的白名单
   - 在前端添加新的状态卡片

2. **增强日志功能**
   - 实现服务器端日志存储
   - 添加日志搜索功能
   - 支持日志分页

3. **告警功能**
   - 添加邮件/短信告警
   - 设置故障阈值
   - 实现告警规则

4. **数据可视化**
   - 添加延迟趋势图表
   - 显示历史统计数据
   - 生成监测报告

## 故障排查

### API连接测试
```bash
# 测试API接口
curl "https://home.liukun.com:8443/api/ping.php?target=www.baidu.com"

# 测试内网
curl "https://home.liukun.com:8443/api/ping.php?target=192.168.1.1"

# 测试国外
curl "https://home.liukun.com:8443/api/ping.php?target=8.8.8.8"
```

### API返回错误
- 检查PHP错误日志
- 确认目标地址在白名单中
- 验证网络连接
- 检查目标端口是否开放

### 前端无响应
- 检查浏览器控制台
- 确认API路径正确 (/api/ping.php)
- 清除浏览器缓存
- 检查CORS设置

## 更新日志

### v1.0.0 (2026-01-21)
- 初始版本发布
- 实现三网监测功能
- 添加日志系统
- 实现统计功能
